<div class="rapport-stocks-container">
  <!-- Header -->
  <p-card styleClass="header-card">
    <div class="header-section">
      <div>
        <h2>Rapport des Stocks</h2>
        <p class="subtitle">Analyse détaillée de vos stocks et inventaires</p>
      </div>
      <button
        pButton
        label="Générer"
        icon="pi pi-refresh"
        (click)="generer()"
        [disabled]="loading"
        class="p-button-primary"
      ></button>
    </div>
  </p-card>

  <p-progressBar *ngIf="loading" mode="indeterminate"></p-progressBar>

  <!-- Contenu du rapport -->
  <div *ngIf="rapport && !loading" class="rapport-content">

    <!-- Cartes KPI -->
    <div class="kpi-grid">
      <p-card styleClass="kpi-card value-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-wallet"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Valeur Totale du Stock</div>
            <div class="kpi-value">{{ formatCurrency(rapport.valeur_totale) }}</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card products-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-box"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Nombre de Produits</div>
            <div class="kpi-value">{{ rapport.nombre_produits }}</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card alert-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-exclamation-triangle"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Produits en Alerte</div>
            <div class="kpi-value">{{ rapport.produits_alerte?.length || 0 }}</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card rupture-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-times-circle"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Produits en Rupture</div>
            <div class="kpi-value">{{ rapport.produits_rupture?.length || 0 }}</div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Graphiques -->
    <div class="charts-grid">
      <!-- Stock par catégorie -->
      <p-card header="Stock par Catégorie" *ngIf="chartCategorie">
        <p-chart
          type="pie"
          [data]="chartCategorie"
          [options]="getPieOptions()"
          height="300px"
        ></p-chart>
      </p-card>

      <!-- Stock par entrepôt -->
      <p-card header="Utilisation des Entrepôts" *ngIf="chartEntrepot">
        <p-chart
          type="bar"
          [data]="chartEntrepot"
          [options]="getBarOptions()"
          height="300px"
        ></p-chart>
      </p-card>
    </div>

    <!-- Alertes -->
    <div class="alerts-grid">
      <!-- Produits en alerte -->
      <p-card header="Produits à Faible Stock" *ngIf="rapport.produits_alerte && rapport.produits_alerte.length > 0">
        <p-table [value]="rapport.produits_alerte" [paginator]="true" [rows]="5">
          <ng-template pTemplate="header">
            <tr>
              <th>Produit</th>
              <th>Stock Actuel</th>
              <th>Seuil Min.</th>
              <th>État</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.nom }}</td>
              <td><strong>{{ item.stock_actuel }}</strong></td>
              <td>{{ item.seuil_minimum }}</td>
              <td>
                <p-tag value="Stock Faible" severity="warning"></p-tag>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <!-- Produits en rupture -->
      <p-card header="Produits en Rupture de Stock" *ngIf="rapport.produits_rupture && rapport.produits_rupture.length > 0">
        <p-table [value]="rapport.produits_rupture" [paginator]="true" [rows]="5">
          <ng-template pTemplate="header">
            <tr>
              <th>Code</th>
              <th>Produit</th>
              <th>État</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.code }}</td>
              <td>{{ item.nom }}</td>
              <td>
                <p-tag value="Rupture" severity="danger"></p-tag>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <!-- Péremption -->
    <p-card header="Produits Proches de la Péremption" *ngIf="rapport.produits_peremption && rapport.produits_peremption.length > 0">
      <p-table [value]="rapport.produits_peremption" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
          <tr>
            <th>Produit</th>
            <th>Lot</th>
            <th>Quantité</th>
            <th>Date Péremption</th>
            <th>Jours Restants</th>
            <th>État</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.produit }}</td>
            <td>{{ item.lot }}</td>
            <td>{{ item.quantite }}</td>
            <td>{{ item.date_peremption | date:'dd/MM/yyyy' }}</td>
            <td><strong>{{ item.jours_restants }}</strong> jours</td>
            <td>
              <p-tag
                [value]="item.jours_restants <= 0 ? 'Périmé' : item.jours_restants <= 3 ? 'Urgent' : 'Attention'"
                [severity]="item.jours_restants <= 0 ? 'danger' : item.jours_restants <= 3 ? 'danger' : 'warning'"
              ></p-tag>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>

  <!-- Message si pas de données -->
  <p-card *ngIf="!rapport && !loading">
    <div class="no-data">
      <i class="pi pi-info-circle"></i>
      <p>Cliquez sur "Générer" pour voir le rapport des stocks</p>
    </div>
  </p-card>
</div>
