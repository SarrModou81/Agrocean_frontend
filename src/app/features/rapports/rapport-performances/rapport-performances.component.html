<div class="rapport-performances-container">
  <!-- Header avec filtres -->
  <p-card styleClass="header-card">
    <div class="header-section">
      <div>
        <h2>Rapport des Performances</h2>
        <p class="subtitle">Analyse des performances opérationnelles et commerciales</p>
      </div>
      <div class="filters">
        <p-calendar
          [(ngModel)]="dateDebut"
          placeholder="Date début"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
        ></p-calendar>
        <p-calendar
          [(ngModel)]="dateFin"
          placeholder="Date fin"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
        ></p-calendar>
        <button
          pButton
          label="Générer"
          icon="pi pi-refresh"
          (click)="generer()"
          [disabled]="loading"
          class="p-button-primary"
        ></button>
      </div>
    </div>
  </p-card>

  <p-progressBar *ngIf="loading" mode="indeterminate"></p-progressBar>

  <!-- Contenu du rapport -->
  <div *ngIf="rapport && !loading" class="rapport-content">

    <!-- Cartes KPI -->
    <div class="kpi-grid">
      <p-card styleClass="kpi-card satisfaction-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-heart"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Taux de Satisfaction</div>
            <div class="kpi-value">{{ rapport.taux_satisfaction?.toFixed(1) || 0 }}%</div>
            <div class="kpi-info">{{ rapport.total_ventes || 0 }} ventes</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card commerciaux-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-users"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Commerciaux Actifs</div>
            <div class="kpi-value">{{ rapport.performance_commerciaux?.length || 0 }}</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card fournisseurs-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-truck"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Fournisseurs Actifs</div>
            <div class="kpi-value">{{ rapport.performance_fournisseurs?.length || 0 }}</div>
          </div>
        </div>
      </p-card>

      <p-card styleClass="kpi-card rotation-card">
        <div class="kpi-content">
          <div class="kpi-icon">
            <i class="pi pi-refresh"></i>
          </div>
          <div class="kpi-details">
            <div class="kpi-label">Produits Suivis</div>
            <div class="kpi-value">{{ rapport.rotation_stocks?.length || 0 }}</div>
          </div>
        </div>
      </p-card>
    </div>

    <!-- Performance des commerciaux -->
    <p-card header="Performance des Commerciaux">
      <p-table [value]="rapport.performance_commerciaux || []" [paginator]="true" [rows]="10">
        <ng-template pTemplate="header">
          <tr>
            <th>Commercial</th>
            <th>Nb Ventes</th>
            <th>Chiffre d'Affaires</th>
            <th>Panier Moyen</th>
            <th>Performance</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td>
              <span class="rank-badge" [class.top]="i < 3">{{ i + 1 }}</span>
              {{ item.commercial }}
            </td>
            <td><strong>{{ item.nombre_ventes }}</strong></td>
            <td>{{ formatCurrency(item.chiffre_affaires) }}</td>
            <td>{{ formatCurrency(item.panier_moyen) }}</td>
            <td>
              <p-progressBar
                [value]="getPerformancePercentage(item, rapport.performance_commerciaux)"
                [showValue]="false"
                [style]="{'height': '8px'}"
              ></p-progressBar>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center">Aucune donnée disponible</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Rotation des stocks et Fournisseurs -->
    <div class="tables-grid">
      <!-- Rotation des stocks -->
      <p-card header="Rotation des Stocks (Top 20)">
        <p-table [value]="rapport.rotation_stocks || []" [paginator]="false">
          <ng-template pTemplate="header">
            <tr>
              <th>Produit</th>
              <th>Stock Moy.</th>
              <th>Qté Vendue</th>
              <th>Taux Rotation</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.produit }}</td>
              <td>{{ item.stock_moyen.toFixed(0) }}</td>
              <td><strong>{{ item.quantite_vendue }}</strong></td>
              <td>
                <span class="rotation-badge" [class.high]="item.taux_rotation > 5" [class.medium]="item.taux_rotation > 2 && item.taux_rotation <= 5" [class.low]="item.taux_rotation <= 2">
                  {{ item.taux_rotation }}
                </span>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">Aucune donnée disponible</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>

      <!-- Performance des fournisseurs -->
      <p-card header="Performance des Fournisseurs">
        <p-table [value]="rapport.performance_fournisseurs || []" [paginator]="false">
          <ng-template pTemplate="header">
            <tr>
              <th>Fournisseur</th>
              <th>Nb Commandes</th>
              <th>Montant Total</th>
              <th>Évaluation</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>{{ item.fournisseur }}</td>
              <td><strong>{{ item.nombre_commandes }}</strong></td>
              <td>{{ formatCurrency(item.montant_total) }}</td>
              <td>
                <div class="rating-stars">
                  <i *ngFor="let star of [1,2,3,4,5]"
                     class="pi"
                     [class.pi-star-fill]="star <= (item.evaluation || 0)"
                     [class.pi-star]="star > (item.evaluation || 0)">
                  </i>
                </div>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" class="text-center">Aucune donnée disponible</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <!-- Résumé statistique -->
    <p-card header="Résumé des Performances">
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Total des Ventes</div>
          <div class="summary-value">{{ rapport.total_ventes || 0 }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Ventes Annulées</div>
          <div class="summary-value negative">{{ rapport.ventes_annulees || 0 }}</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Taux de Satisfaction</div>
          <div class="summary-value positive">{{ rapport.taux_satisfaction?.toFixed(1) || 0 }}%</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Période d'Analyse</div>
          <div class="summary-value info">
            {{ formatDateRange() }}
          </div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Message si pas de données -->
  <p-card *ngIf="!rapport && !loading">
    <div class="no-data">
      <i class="pi pi-info-circle"></i>
      <p>Sélectionnez une période et cliquez sur "Générer" pour voir le rapport</p>
    </div>
  </p-card>
</div>
