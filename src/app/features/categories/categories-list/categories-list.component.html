<div class="categories-container">
  <p-card>
    <div class="header-section">
      <h2>Gestion des Catégories</h2>
      <button pButton icon="pi pi-plus" label="Nouvelle Catégorie" (click)="openNew()"></button>
    </div>

    <p-table [value]="categories" [loading]="loading" responsiveLayout="scroll">
      <ng-template pTemplate="header">
        <tr>
          <th>Nom</th>
          <th>Code Préfixe</th>
          <th>Description</th>
          <th>Type de Stockage</th>
          <th>Nb Produits</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-categorie>
        <tr>
          <td><strong>{{ categorie.nom }}</strong></td>
          <td>
            <span class="code-badge" *ngIf="categorie.code_prefix">{{ categorie.code_prefix }}</span>
            <span *ngIf="!categorie.code_prefix" class="text-muted">-</span>
          </td>
          <td>{{ categorie.description || '-' }}</td>
          <td>
            <p-tag [value]="categorie.type_stockage" [severity]="getTypeStockageSeverity(categorie.type_stockage)"></p-tag>
          </td>
          <td>{{ categorie.produits_count || 0 }}</td>
          <td>
            <button pButton icon="pi pi-pencil" class="p-button-text" (click)="editCategorie(categorie)" pTooltip="Modifier"></button>
            <button pButton icon="pi pi-trash" class="p-button-text p-button-danger" (click)="deleteCategorie(categorie)" pTooltip="Supprimer"></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">Aucune catégorie trouvée</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Dialog pour créer/modifier -->
<p-dialog [(visible)]="displayDialog" [header]="selectedCategorie?.id ? 'Modifier la catégorie' : 'Nouvelle catégorie'" [modal]="true" [style]="{width: '500px'}">
  <div class="p-fluid" *ngIf="selectedCategorie">
    <!-- Code Prefix généré automatiquement - affiché uniquement en mode édition -->
    <div class="p-field" *ngIf="selectedCategorie.id && selectedCategorie.code_prefix">
      <label>Code Préfixe</label>
      <input
        type="text"
        pInputText
        [value]="selectedCategorie.code_prefix"
        [disabled]="true"
        class="code-readonly"
      />
      <small class="text-info">
        <i class="pi pi-info-circle"></i> Le code préfixe est généré automatiquement et ne peut pas être modifié
      </small>
    </div>

    <div class="p-field">
      <label>Nom *</label>
      <input type="text" pInputText [(ngModel)]="selectedCategorie.nom" required />
    </div>

    <div class="p-field">
      <label>Description</label>
      <textarea pInputTextarea [(ngModel)]="selectedCategorie.description" rows="3"></textarea>
    </div>

    <div class="p-field">
      <label>Type de Stockage *</label>
      <p-dropdown [(ngModel)]="selectedCategorie.type_stockage" [options]="[
        {label: 'Frais', value: 'Frais'},
        {label: 'Congelé', value: 'Congelé'},
        {label: 'Ambiant Sec', value: 'AmbiantSec'},
        {label: 'Ambiant Humide', value: 'AmbiantHumide'}
      ]" optionLabel="label" optionValue="value"></p-dropdown>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Annuler" icon="pi pi-times" class="p-button-text" (click)="displayDialog = false"></button>
    <button pButton label="Enregistrer" icon="pi pi-check" (click)="saveCategorie()"></button>
  </ng-template>
</p-dialog>

