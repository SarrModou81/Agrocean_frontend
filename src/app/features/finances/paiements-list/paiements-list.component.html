<div class="paiements-container">
  <p-card>
    <div class="header-section">
      <h2>Gestion des Paiements</h2>
      <button 
        pButton 
        icon="pi pi-plus" 
        label="Nouveau Paiement" 
        (click)="openNew()"
        class="p-button-success"
      ></button>
    </div>

    <div class="filters-section">
      <div class="filter-group">
        <label>Date Début</label>
        <p-calendar 
          [(ngModel)]="dateDebut"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
        ></p-calendar>
      </div>

      <div class="filter-group">
        <label>Date Fin</label>
        <p-calendar 
          [(ngModel)]="dateFin"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
        ></p-calendar>
      </div>

      <div class="filter-group">
        <label>Mode de Paiement</label>
        <p-dropdown 
          [(ngModel)]="selectedMode"
          [options]="modes"
          optionLabel="label"
          optionValue="value"
          placeholder="Tous"
          [showClear]="true"
        ></p-dropdown>
      </div>

      <div class="filter-actions">
        <button 
          pButton 
          icon="pi pi-search" 
          label="Rechercher"
          (click)="applyFilters()"
        ></button>
        <button 
          pButton 
          icon="pi pi-times" 
          label="Effacer"
          class="p-button-secondary"
          (click)="clearFilters()"
        ></button>
      </div>
    </div>

    <p-table 
      [value]="paiements" 
      [loading]="loading"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} paiements"
      responsiveLayout="scroll"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Date</th>
          <th>Client/Fournisseur</th>
          <th>Facture</th>
          <th>Montant</th>
          <th>Mode</th>
          <th>Référence</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-paiement>
        <tr>
          <td>{{ paiement.date_paiement | date:'dd/MM/yyyy' }}</td>
          <td>
            <strong>{{ paiement.client?.nom || paiement.fournisseur?.nom }}</strong>
          </td>
          <td>
            <code *ngIf="paiement.facture">{{ paiement.facture.numero }}</code>
            <span *ngIf="!paiement.facture">N/A</span>
          </td>
          <td><strong>{{ formatCurrency(paiement.montant) }}</strong></td>
          <td>
            <p-tag [value]="paiement.mode_paiement" [severity]="getModeSeverity(paiement.mode_paiement)"></p-tag>
          </td>
          <td>{{ paiement.reference || 'N/A' }}</td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">Aucun paiement trouvé</td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog 
  [(visible)]="displayDialog" 
  header="Nouveau Paiement"
  [modal]="true" 
  [style]="{width: '500px'}"
  (onHide)="onDialogHide()"
>
  <app-paiement-form 
    (formSubmitted)="displayDialog = false"
  ></app-paiement-form>
</p-dialog>

<p-toast></p-toast>