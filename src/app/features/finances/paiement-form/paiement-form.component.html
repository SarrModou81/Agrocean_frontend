<!-- src/app/features/finances/paiement-form/paiement-form.component.html -->
<form [formGroup]="paiementForm" (ngSubmit)="onSubmit()">
  <div class="p-fluid">
    <!-- Sélection Type de Paiement -->
    <div class="field" *ngIf="!facture && !factureFournisseur">
      <label>Type de Paiement *</label>
      <p-selectButton 
        [options]="[
          { label: 'Client', value: 'client' },
          { label: 'Fournisseur', value: 'fournisseur' }
        ]"
        [(ngModel)]="typePaiement"
        [ngModelOptions]="{standalone: true}"
        (onChange)="loadFactures(); initForm();"
      ></p-selectButton>
    </div>

    <!-- Facture Client -->
    <div class="field" *ngIf="typePaiement === 'client' && !facture">
      <label for="facture_id">Facture Client *</label>
      <p-dropdown 
        id="facture_id"
        formControlName="facture_id"
        [options]="factures"
        optionLabel="numero"
        optionValue="id"
        placeholder="Sélectionner une facture"
        [filter]="true"
        filterBy="numero"
        [class.ng-invalid]="isFieldInvalid('facture_id')"
      >
        <ng-template let-facture pTemplate="item">
          <div class="facture-dropdown-item">
            <strong>{{ facture.numero }}</strong>
            <br>
            <small>{{ facture.vente?.client?.nom }} - {{ formatCurrency(facture.montant_ttc) }}</small>
            <br>
            <small class="text-danger"><strong>Restant: {{ formatCurrency(facture.montant_restant) }}</strong></small>
          </div>
        </ng-template>
      </p-dropdown>
      <small class="p-error" *ngIf="isFieldInvalid('facture_id')">
        La facture est requise
      </small>
    </div>

    <!-- Facture Fournisseur -->
    <div class="field" *ngIf="typePaiement === 'fournisseur' && !factureFournisseur">
      <label for="facture_fournisseur_id">Facture Fournisseur *</label>
      <p-dropdown 
        id="facture_fournisseur_id"
        formControlName="facture_fournisseur_id"
        [options]="facturesFournisseurs"
        optionLabel="numero"
        optionValue="id"
        placeholder="Sélectionner une facture fournisseur"
        [filter]="true"
        filterBy="numero"
        [class.ng-invalid]="isFieldInvalid('facture_fournisseur_id')"
      >
        <ng-template let-facture pTemplate="item">
          <div class="facture-dropdown-item">
            <strong>{{ facture.numero }}</strong>
            <br>
            <small>{{ facture.fournisseur?.nom }} - {{ formatCurrency(facture.montant_total) }}</small>
            <br>
            <small class="text-danger"><strong>Restant: {{ formatCurrency(facture.montant_restant) }}</strong></small>
          </div>
        </ng-template>
      </p-dropdown>
      <small class="p-error" *ngIf="isFieldInvalid('facture_fournisseur_id')">
        La facture fournisseur est requise
      </small>
    </div>

    <!-- Info Facture Client -->
    <div class="facture-info" *ngIf="typePaiement === 'client' && facture">
      <h4>Facture Client {{ facture.numero }}</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Client:</span>
          <span class="value">{{ facture.vente?.client?.nom }}</span>
        </div>
        <div class="info-item">
          <span class="label">Montant total:</span>
          <span class="value">{{ formatCurrency(montantTotal) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Déjà payé:</span>
          <span class="value success">{{ formatCurrency(montantPaye) }}</span>
        </div>
        <div class="info-item highlight">
          <span class="label">Montant restant:</span>
          <span class="value danger"><strong>{{ formatCurrency(montantRestant) }}</strong></span>
        </div>
      </div>
    </div>

    <!-- Info Facture Fournisseur -->
    <div class="facture-info" *ngIf="typePaiement === 'fournisseur' && factureFournisseur">
      <h4>Facture Fournisseur {{ factureFournisseur.numero }}</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="label">Fournisseur:</span>
          <span class="value">{{ factureFournisseur.fournisseur?.nom }}</span>
        </div>
        <div class="info-item">
          <span class="label">Montant total:</span>
          <span class="value">{{ formatCurrency(montantTotal) }}</span>
        </div>
        <div class="info-item">
          <span class="label">Déjà payé:</span>
          <span class="value success">{{ formatCurrency(montantPaye) }}</span>
        </div>
        <div class="info-item highlight">
          <span class="label">Montant restant:</span>
          <span class="value danger"><strong>{{ formatCurrency(montantRestant) }}</strong></span>
        </div>
      </div>
    </div>

    <!-- Montant à payer -->
    <div class="field">
      <label for="montant">Montant à payer *</label>
      <div class="montant-input-container">
        <p-inputNumber 
          id="montant"
          formControlName="montant"
          mode="decimal"
          [minFractionDigits]="0"
          [maxFractionDigits]="2"
          [min]="0.01"
          [max]="montantRestant"
          [class.ng-invalid]="isFieldInvalid('montant')"
          suffix=" FCFA"
        ></p-inputNumber>
        <button 
          type="button"
          pButton 
          label="Tout payer"
          class="p-button-sm p-button-text"
          (click)="paiementForm.patchValue({ montant: montantRestant })"
          *ngIf="montantRestant > 0"
        ></button>
      </div>
      <small class="p-error" *ngIf="getMontantError()">
        {{ getMontantError() }}
      </small>
      <small class="p-info" *ngIf="!getMontantError() && montantRestant > 0">
        Maximum : {{ formatCurrency(montantRestant) }}
      </small>
    </div>

    <div class="field">
      <label for="date_paiement">Date de Paiement *</label>
      <p-calendar 
        id="date_paiement"
        formControlName="date_paiement"
        [showIcon]="true"
        dateFormat="dd/mm/yy"
        [class.ng-invalid]="isFieldInvalid('date_paiement')"
      ></p-calendar>
      <small class="p-error" *ngIf="isFieldInvalid('date_paiement')">
        La date est requise
      </small>
    </div>

    <div class="field">
      <label for="mode_paiement">Mode de Paiement *</label>
      <p-dropdown 
        id="mode_paiement"
        formControlName="mode_paiement"
        [options]="modes"
        optionLabel="label"
        optionValue="value"
        placeholder="Sélectionner un mode"
        [class.ng-invalid]="isFieldInvalid('mode_paiement')"
      ></p-dropdown>
      <small class="p-error" *ngIf="isFieldInvalid('mode_paiement')">
        Le mode de paiement est requis
      </small>
    </div>

    <div class="field">
      <label for="reference">Référence</label>
      <input 
        id="reference" 
        type="text" 
        pInputText 
        formControlName="reference"
        placeholder="Numéro de chèque, transaction..."
      >
    </div>

    <!-- Résumé du paiement -->
    <div class="paiement-summary" *ngIf="paiementForm.get('montant')?.value && paiementForm.get('montant')?.value > 0">
      <div class="summary-item">
        <span>Montant à payer:</span>
        <strong>{{ formatCurrency(paiementForm.get('montant')?.value) }}</strong>
      </div>
      <div class="summary-item" *ngIf="montantRestant > 0">
        <span>Nouveau montant restant:</span>
        <strong [class.text-success]="(montantRestant - paiementForm.get('montant')?.value) === 0">
          {{ formatCurrency(Math.max(0, montantRestant - paiementForm.get('montant')?.value)) }}
        </strong>
      </div>
      <div class="summary-item success-bg" *ngIf="montantRestant > 0 && (montantRestant - paiementForm.get('montant')?.value) === 0">
        <i class="pi pi-check-circle"></i>
        <span>La facture sera entièrement payée</span>
      </div>
    </div>

    <div class="form-actions">
      <button 
        pButton 
        type="submit" 
        label="Enregistrer le paiement"
        icon="pi pi-check"
        [loading]="loading"
        [disabled]="paiementForm.invalid || loading || montantRestant === 0"
        class="p-button-success"
      ></button>
    </div>

    <!-- Message si déjà payé -->
    <div class="alert-info" *ngIf="montantRestant === 0">
      <i class="pi pi-info-circle"></i>
      <span>Cette facture est déjà entièrement payée</span>
    </div>
  </div>
</form>